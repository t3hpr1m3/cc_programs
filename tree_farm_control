local ENGINE_COLOR = colors.white
local ENGINE_SIDE = "bottom"
local engineStatus = nil

local CELL_SIDE = "back"

local FARM_SIDE = "top"

local w, h = term.getSize()

function getEngineStatus()
	if engineStatus == nil then
		engineStatus = (redstone.getBundledOutput(ENGINE_SIDE) ~= ENGINE_COLOR)
	end
	return engineStatus
end

function setEngineStatus(status)
	if status ~= getEngineStatus() then
		if status == true then
			redstone.setBundledOutput(ENGINE_SIDE, 0)
		else
			redstone.setBundledOutput(ENGINE_SIDE, ENGINE_COLOR)
		end
		engineStatus = status
		printEngineStatus()
	end
end

function getCellStats(c)
	stats = c.getPowerProvider()
	stats["full"] = stats["energyStored"] == stats["maxEnergyStored"]
	stats["drained"] = stats["maxEnergyStored"] / stats["energyStored"] < .1
	return stats
end

function printCellStats(stats)
	local x, y, i, barWidth, current, currentString
	term.setCursorPos(1, 1)
	term.clearLine()
	term.write("Cell:    [")
	x, y = term.getCursorPos()
	barWidth = w - x
	term.setCursorPos(w, 1)
	term.write("]")
	term.setCursorPos(x, 1)
	current = stats["energyStored"] / stats["maxEnergyStored"]
	for i = 1, math.floor(barWidth * current) do
		term.write("#")
	end
	currentString = " " .. math.floor(current * 100) .. "% "
	term.setCursorPos(w - (barWidth / 2) - (#currentString / 2), y)
	term.write(currentString)
end

function printEngineStatus()
	local status = getEngineStatus()
	term.setCursorPos(1, 2)
	term.clearLine()
	term.write("Engines: ")
	if status == true then
		term.write("     ON")
	else
		term.write("OFF")
	end
end

function toggleFarmStatus()
	if redstone.getOutput(FARM_SIDE) == true then
		redstone.setOutput(FARM_SIDE, false)
	else
		redstone.setOutput(FARM_SIDE, true)
	end
	printFarmStatus()
end

function printFarmStatus()
	local disabled = redstone.getOutput(FARM_SIDE)
	term.setCursorPos(1, 3)
	term.clearLine()
	term.write("Farm:    ")
	if disabled == false then
		term.write("     ON")
	else
		term.write("OFF")
	end
end

local on = true
local interval = 5

local cell = peripheral.wrap(CELL_SIDE)
local cellStats = getCellStats(cell)
term.clear()

term.setCursorPos(1, 6)
term.clearLine()
term.write("Press 'T' to toggle the farm status.")
term.setCursorPos(1, 7)
term.clearLine()
term.write("Press 'E' to force the engines to 'ON'.")
term.setCursorPos(1, 8)
term.clearLine()
term.write("Press 'Q' to exit.")
printCellStats(cellStats)
printEngineStatus()
local timer = os.startTimer(0)


while on do
	local event, p1, p2, p3 = os.pullEvent()
	if event == "timer" then
		cellStats = getCellStats(cell)
		printCellStats(cellStats)
		printFarmStatus()
		if cellStats["drained"] == true then
			setEngineStatus(true)
		elseif cellStats["full"] == true then
			setEngineStatus(false)
		end
		os.startTimer(interval)
	elseif (event == "key") then
		if keys.getName(p1) == "t" then
			toggleFarmStatus()
		elseif keys.getName(p1) == "e" then
			setEngineStatus(true)
		elseif keys.getName(p1) == "q" then
			term.clear()
			term.setCursorPos(1, 1)
			print("Exiting...")
			on = false
			os.queueEvent("dummy")
			os.pullEvent()
		end
	end
end
